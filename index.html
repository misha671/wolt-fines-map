<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wolt –®—Ç—Ä–∞—Ñ—ã - –ö–∞—Ä—Ç–∞</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            overflow: hidden;
        }
        #map {
            width: 100vw;
            height: 100vh;
        }
        .info-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            max-width: 250px;
        }
        .info-title {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 10px;
            color: #333;
        }
        .info-item {
            font-size: 14px;
            margin: 5px 0;
            color: #666;
        }
        .status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status.active {
            background: #4CAF50;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px;
            color: #666;
            z-index: 2000;
        }
    </style>
</head>
<body>
    <div id="loader" class="loader">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã...</div>
    <div id="map"></div>
    <div class="info-panel">
        <div class="info-title">üìç Wolt –®—Ç—Ä–∞—Ñ—ã</div>
        <div class="info-item">
            <span class="status active"></span>
            –¢–æ—á–µ–∫: <span id="count">0</span>
        </div>
        <div class="info-item">
            –û–±–Ω–æ–≤–ª–µ–Ω–æ: <span id="updated">-</span>
        </div>
        <div class="info-item" style="font-size: 12px; color: #999; margin-top: 10px;">
            –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: 15 —Å–µ–∫
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
        const tg = window.Telegram?.WebApp;
        if (tg) {
            tg.ready();
            tg.expand();
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
        const GITHUB_URL = 'https://raw.githubusercontent.com/misha671/wolt-fines-map/main/locations.json';
        const UPDATE_INTERVAL = 15000; // 15 —Å–µ–∫—É–Ω–¥
        const HOURS_LIMIT = 4;

        // –°–æ–∑–¥–∞—ë–º –∫–∞—Ä—Ç—É —Å —Ü–µ–Ω—Ç—Ä–æ–º –Ω–∞ –•–µ–ª—å—Å–∏–Ω–∫–∏
        const map = L.map('map').setView([60.1699, 24.9384], 12);

        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–∞–π–ª—ã –∫–∞—Ä—Ç—ã
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        // –°–ª–æ–π –¥–ª—è –º–∞—Ä–∫–µ—Ä–æ–≤
        let markersLayer = L.layerGroup().addTo(map);

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Ç–æ—á–µ–∫ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
        function filterByTime(locations) {
            const now = new Date();
            const cutoff = new Date(now - HOURS_LIMIT * 60 * 60 * 1000);

            return locations.filter(loc => {
                try {
                    const locTime = new Date(loc.timestamp);
                    return locTime > cutoff;
                } catch {
                    return false;
                }
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
        async function loadLocations() {
            try {
                const response = await fetch(GITHUB_URL + '?t=' + Date.now());
                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
                }

                const locations = await response.json();
                const filtered = filterByTime(locations);

                // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –º–∞—Ä–∫–µ—Ä—ã
                markersLayer.clearLayers();

                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –º–∞—Ä–∫–µ—Ä—ã
                filtered.forEach((loc, index) => {
                    const marker = L.marker([loc.latitude, loc.longitude])
                        .addTo(markersLayer);

                    // –°–æ–∑–¥–∞—ë–º popup —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
                    const time = new Date(loc.timestamp);
                    const timeStr = time.toLocaleString('ru-RU', {
                        day: '2-digit',
                        month: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    let popupContent = `<b>–®—Ç—Ä–∞—Ñ #${filtered.length - index}</b><br>`;
                    popupContent += `‚è∞ ${timeStr}<br>`;
                    popupContent += `üìç ${loc.latitude.toFixed(6)}, ${loc.longitude.toFixed(6)}`;

                    if (loc.message_text && loc.message_text.trim()) {
                        popupContent += `<br><br>${loc.message_text.substring(0, 200)}`;
                    }

                    marker.bindPopup(popupContent);
                });

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                document.getElementById('count').textContent = filtered.length;
                const now = new Date();
                document.getElementById('updated').textContent = now.toLocaleTimeString('ru-RU', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });

                // –°–∫—Ä—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
                document.getElementById('loader').style.display = 'none';

                // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ —Ç–æ—á–∫–∞—Ö
                if (filtered.length > 0) {
                    const bounds = L.latLngBounds(filtered.map(loc => [loc.latitude, loc.longitude]));
                    map.fitBounds(bounds, { padding: [50, 50] });
                }

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                document.getElementById('loader').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        loadLocations();

        // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 15 —Å–µ–∫—É–Ω–¥
        setInterval(loadLocations, UPDATE_INTERVAL);
    </script>
</body>
</html>
